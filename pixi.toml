[workspace]
authors = ["Julia Jia <juliajster@gmail.com>"]
channels = ["conda-forge", "https://prefix.dev/robostack-kilted"]
name = "demos"
platforms = ["linux-64", "linux-aarch64"]
version = "0.1.0"

[tasks]
# ML dependencies - consolidated installation (recommended)
# Automatically detects GPU, installs appropriate PyTorch, and installs lerobot
install-ml-deps = { cmd = "bash scripts/install_ml_deps.sh" }

# Build
build = { cmd = ["colcon", "build", "--cmake-args", "-DCMAKE_BUILD_TYPE=Release"]}
clean = { cmd = "rm -rf build install log" }

# Run Demos
start_zenoh = { cmd = [
  "ros2",
  "run",
  "rmw_zenoh_cpp",
  "rmw_zenohd",
]}
so-arm-gz = { cmd = ["ros2", "launch", "pai_bringup", "so_arm_gz_bringup.launch.py"] }
so-arm-mujoco = { cmd = ["ros2", "launch", "pai_bringup", "so_arm_mujoco_bringup.launch.py"] }
rosetta-record-mujoco = { cmd = [
  "ros2",
  "launch",
  "rosetta",
  "episode_recorder_launch.py",
  "contract_path:=$(ros2 pkg prefix pai_data_collection)/share/pai_data_collection/config/rosetta/so_arm101.yaml",
  "bag_base_dir:=datasets/so_arm101_mujoco/bags",
] }
# Run LeRobot inference node
# Download model first: python pai_bringup/test/download_lerobot_model
# Override: pixi run lerobot-inference --ros-args -p policy_path:=/path/to/model
lerobot-inference = { cmd = [
  "python3",
  "pai_bringup/scripts/lerobot_inference_node",
  "--ros-args",
  "-p",
  "camera_topic:=/camera",
  "-p",
  "command_topic:=/forward_position_controller/commands",
  "-p",
  "task:=Move to blue cube",
  "-p",
  "device:=cuda",
]}
test-joints = { cmd = [
  "ros2",
  "topic",
  "pub",
  "/forward_position_controller/commands",
  "std_msgs/msg/Float64MultiArray",
  "{layout: {dim: [{label: joint, size: 6, stride: 1}]}, data: [0.2,-0.4,0,0,0,0.4]}",
  "--rate",
  "10",
]}

[dependencies]
# Build deps
colcon-common-extensions = ">=0.3.0,<0.4"
colcon-mixin = ">=0.2.3,<0.3"
cmake = ">=3.30.5,<4"
ninja = ">=1.13.1,<2"
pkg-config = "*"
vcstool = "*"
rosdep = "*"
ffmpeg = "*"
# Required by feetech_ros2_driver
cpp-expected = ">=1.1.0,<2"
range-v3 = ">=0.12.0,<0.13"

# Common base deps
python = "3.12.*"
pip = "*"
numpy = ">=1.26.4,<3"
# Explicitly installing pillow through Conda (rather that letting pip pull it an as transitive dependency)
# to avoid related issue to: libtiff.so.6: undefined symbol: jpeg12_write_raw_data, version LIBJPEG_8.0.
pillow = "*"
# Pinned to <26 to satisfy lerobot==0.4.3 requirement (packaging>=24.2,<26.0)
packaging = ">=24.2,<26"

# ROS dependencies
ros-kilted-ros-core = "*"
ros-kilted-ament-cmake = "*"
# From pai_bringup
ros-kilted-controller-manager = "*"
ros-kilted-cv-bridge = "*"
ros-kilted-launch = "*"
ros-kilted-launch-ros = "*"
ros-kilted-rclpy = "*"
ros-kilted-robot-state-publisher = "*"
ros-kilted-ros-gz-bridge = "*"
ros-kilted-ros-gz-sim = "*"
# From pai_data_collection
ros-kilted-rosbag2-py = "*"
ros-kilted-rosbag2-storage-mcap = "*"
# Gazebo Sim (provides gz CLI and simulation engine)
# Using version 9 to match ROS Kilted compatibility
gz-sim9 = "*"
# Gazebo GUI (required for gz sim -g)
gz-gui9 = "*"
# Gazebo Rendering (required for ogre2 render engine plugin)
gz-rendering9 = "*"
ros-kilted-rviz2 = "*"
ros-kilted-sensor-msgs = "*"
ros-kilted-std-msgs = "*"
ros-kilted-xacro = "*"
# From so_arm100_description
ros-kilted-joint-state-broadcaster = "*"
ros-kilted-joint-trajectory-controller = "*"
ros-kilted-parallel-gripper-controller = "*"
ros-kilted-position-controllers = "*"
ros-kilted-hardware-interface = "*"
ros-kilted-transmission-interface = "*"
ros-kilted-ament-index-python = "*"
ros-kilted-nav2-common = "*"
ros-kilted-gz-ros2-control = "*"
# From so_arm100_moveit_config
ros-kilted-moveit-ros-move-group = "*"
ros-kilted-moveit-kinematics = "*"
ros-kilted-moveit-planners = "*"
ros-kilted-moveit-simple-controller-manager = "*"
ros-kilted-joint-state-publisher = "*"
ros-kilted-joint-state-publisher-gui = "*"
ros-kilted-tf2-ros = "*"
ros-kilted-moveit-ros-control-interface = "*"
ros-kilted-moveit-ros-visualization = "*"
ros-kilted-moveit-ros-warehouse = "*"
ros-kilted-moveit-setup-assistant = "*"
ros-kilted-rviz-common = "*"
ros-kilted-rviz-default-plugins = "*"
# From feetech_ros2_driver
ros-kilted-rclcpp = "*"
ros-kilted-pluginlib = "*"
# Zenoh middleware
ros-kilted-rmw-zenoh-cpp = "*"

[pypi-dependencies]
huggingface-hub = "*"
lerobot = { version = "==0.4.3", extras = ["feetech"] }

[activation]
scripts = ["install/setup.bash"]

[activation.env]
# Ensures the linker knows where to look for conda managed packages
LIBRARY_PATH = "${CONDA_PREFIX}/lib:${LIBRARY_PATH}"
LD_LIBRARY_PATH = "${CONDA_PREFIX}/lib:${LD_LIBRARY_PATH}"
# CMake needs this to find ROS 2 packages installed by robostack
CMAKE_PREFIX_PATH = "${CONDA_PREFIX}"
# pkg-config needs this to find system-installed packages like libserial-dev
# Supports both x86_64 and aarch64 architectures
PKG_CONFIG_PATH = "/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH}"
# Gazebo rendering engine plugin path
GZ_RENDERING_ENGINE_PATH = "${CONDA_PREFIX}/lib/gz-rendering-9/engine-plugins"
ROS_DISTRO = "kilted"
# Force ROS 2 to use Zenoh middleware
RMW_IMPLEMENTATION = "rmw_zenoh_cpp"
